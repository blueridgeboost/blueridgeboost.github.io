{{ $id := .Params.ecwid }}
{{ $ecwid_category := .Params.category }}

<div
  id="class-{{ $id }}"
  {{ if .Params.day_tags }}
    data-day='{{ delimit .Params.day_tags "#" }}'
  {{ else }}
    data-day='[]'
  {{ end }}
  {{ if .Params.duration }}
    data-duration='{{ .Params.duration }}'
  {{ else }}
    data-duration='[]'
  {{ end }}
  data-schedule='{{ delimit .Params.schedule_tags "#" }}'
  data-grade='{{ delimit .Params.grade_tags "#" }}'
  data-subject='{{ delimit .Params.subject_tags "#" }}'
  style="padding-left: 0px; padding-right: 0px; margin-right: 0.25rem; margin-left: 0.25rem;"
  class="ecsp-media"
>
  {{ with .Params.ribbon }}
    <span class="ecsp-ribbon">{{ . }}</span>
  {{ end }}

  <div
    class="ecsp ecsp-SingleProduct-v2 ecsp-SingleProduct-v2-bordered ecsp-SingleProduct-v2-centered ecsp-Product ec-Product-{{ $id }}"
    itemscope
    itemtype="http://schema.org/Product"
    data-single-product-id="{{ $id }}"
  >
    <meta itemprop="name" content="{{ .Params.page_title }}">
    <a href="{{ .RelPermalink }}" class="ecsp-image-link">
      <div class="ecsp-image" itemprop="image"></div>
    </a>

    {{ with .Params.day_tags }}
      {{ $n := len . }}
      {{ if eq $n 1 }}
        {{ index . 0 }}
      {{ else if eq $n 2 }}
        {{ index . 0 }}, {{ index . 1 }}
      {{ else if eq $n 3 }}
        {{ index . 0 }}, {{ index . 1 }}, {{ index . 2 }}
      {{ else if ge $n 4 }}
        {{ index . 0 }} through {{ index . (sub $n 1) }}
      {{ end }}
    {{ else }}
      Pick a day and time
    {{ end }}

    {{ if and .Params.start_time .Params.end_time }}
      {{ .Params.start_time }} &ndash; {{ .Params.end_time }}<br>
    {{ else }}
      <br>
    {{ end }}

    {{ with .Params.grade_tags }}
      {{ if gt (len .) 0 }}
        Grades:
        {{ index . 0 }}
        {{ if gt (len .) 1 }}
          to {{ index . (sub (len .) 1) }}
        {{ end }}
        <br>
      {{ end }}
    {{ end }}

    <div itemtype="http://schema.org/Offer" itemscope itemprop="offers">
      <meta itemprop="price" content="{{ .Params.price }}">
      <meta itemprop="priceCurrency" content="USD">
      <link itemprop="availability" href="http://schema.org/InStock">
      <meta itemprop="itemCondition" content="http://schema.org/NewCondition">
    </div>

    {{/* Only output Event JSON if NOT On-Demand */}}
    {{ $isOnDemand := false }}
    {{ with .Params.schedule_tags }}
      {{ if in . "On-Demand" }}
        {{ $isOnDemand = true }}
      {{ end }}
    {{ end }}

    {{ if not $isOnDemand }}
      {{/* Precompute times (24h) safely */}}
      {{ $start24 := "" }}
      {{ with .Params.start_time }}
        {{ $start24 = time.Format "15:04" (time .) }}
      {{ end }}
      {{ $end24 := "" }}
      {{ with .Params.end_time }}
        {{ $end24 = time.Format "15:04" (time .) }}
      {{ end }}

      {{/* Build byDay array from day_tags */}}
      {{ $byDay := slice }}
      {{ range .Params.day_tags }}
        {{- $d := . -}}
        {{- if eq $d "Mon" -}}
          {{- $byDay = $byDay | append "https://schema.org/Monday" -}}
        {{- else if eq $d "Tue" -}}
          {{- $byDay = $byDay | append "https://schema.org/Tuesday" -}}
        {{- else if eq $d "Wed" -}}
          {{- $byDay = $byDay | append "https://schema.org/Wednesday" -}}
        {{- else if eq $d "Thu" -}}
          {{- $byDay = $byDay | append "https://schema.org/Thursday" -}}
        {{- else if eq $d "Fri" -}}
          {{- $byDay = $byDay | append "https://schema.org/Friday" -}}
        {{- else if eq $d "Sat" -}}
          {{- $byDay = $byDay | append "https://schema.org/Saturday" -}}
        {{- else if eq $d "Sun" -}}
          {{- $byDay = $byDay | append "https://schema.org/Sunday" -}}
        {{- end -}}
      {{ end }}

      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "EducationEvent",
        "name": {{ jsonify .Params.page_title }},
        "description": {{ jsonify (or .Params.description .Summary) }},
        "url": {{ jsonify .Permalink }},
        "eventStatus": "https://schema.org/EventScheduled",
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "location": {
          "@type": "Place",
          "name": "Blue Ride Boost",
          "address": {
            "@type": "PostalAddress",
            "streetAddress": {{ jsonify (or .Params.address_street "2171 Ivy Rd") }},
            "addressLocality": {{ jsonify (or .Params.address_city "Charlottesville") }},
            "addressRegion": {{ jsonify (or .Params.address_region "Virginia") }},
            "postalCode": {{ jsonify (or .Params.address_postal "22903") }},
            "addressCountry": {{ jsonify (or .Params.address_country "US") }}
          }
        },
        "organizer": {
          "@type": "Organization",
          "name": {{ jsonify (or .Site.Title "Blue Ridge Boost") }},
          "url": {{ jsonify .Site.BaseURL }}
        },
        "offers": {
          "@type": "Offer",
          "price": {{ jsonify (printf "%.2f" (float .Params.price)) }},
          "priceCurrency": "USD",
          "availability": "https://schema.org/InStock",
          "url": {{ jsonify .Permalink }}
        },
        "eventSchedule": {
          "@type": "Schedule",
          "startDate": {{ jsonify (or .Params.schedule.startDate "2025-09-09") }},
          "endDate": {{ jsonify (or .Params.schedule.endDate "2025-12-02") }},
          "byDay": {{ jsonify $byDay }}{{ if or $start24 $end24 }},{{ end }}
          {{- if or $start24 $end24 -}}
            {{- if $start24 -}}
              "startTime": {{ jsonify $start24 }}{{ if $end24 }},{{ end }}
            {{- end -}}
            {{- if $end24 -}}
              "endTime": {{ jsonify $end24 }},
            {{- end -}}
            "scheduleTimezone": "America/New_York",
            "repeatFrequency": "P1W"
          {{- else -}}
            "scheduleTimezone": "America/New_York",
            "repeatFrequency": "P1W"
          {{- end }}
        }
      }
      </script>
    {{ end }}
  </div>

  <!-- Optional: mirror Ecwid image into Product microdata so parsers can see it -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var productEl = document.querySelector('.ec-Product-{{ $id }}[itemtype="http://schema.org/Product"]');
      if (!productEl) return;
      function setProductImageMeta(url) {
        if (!url) return;
        var m = productEl.querySelector('meta[itemprop="image"]');
        if (!m) {
          m = document.createElement('meta');
          m.setAttribute('itemprop', 'image');
          productEl.prepend(m);
        }
        m.setAttribute('content', url);
      }
      function tagImg() {
        var img = productEl.querySelector('img');
        if (img) {
          if (!img.hasAttribute('itemprop')) img.setAttribute('itemprop', 'image');
          setProductImageMeta(img.currentSrc || img.src);
        }
      }
      tagImg();
      var obs = new MutationObserver(tagImg);
      obs.observe(productEl, { childList: true, subtree: true });
    });
  </script>

  <script type="text/javascript">
    window.ec = window.ec || {};
    window.ec.storefront = window.ec.storefront || {};
    window.ec.storefront.enable_navigation = true;
    window.ec.storefront.product_details_layout = "THREE_COLUMNS_SIDEBAR_ON_THE_RIGHT";
    window.ec.storefront.product_details_gallery_layout = "SINGLE_IMAGE";
    window.ec.storefront.product_details_two_columns_with_right_sidebar_show_product_description_on_sidebar = false;
    window.ec.storefront.product_details_two_columns_with_left_sidebar_show_product_description_on_sidebar = false;
    window.ec.storefront.product_details_show_product_name = true;
    window.ec.storefront.product_details_show_breadcrumbs = false;
    window.ec.storefront.product_details_show_product_sku = false;
    window.ec.storefront.product_details_show_product_price = true;
    window.ec.storefront.product_details_show_in_stock_label = true;
    window.ec.storefront.product_details_show_number_of_items_in_stock = true;
    window.ec.storefront.product_details_show_qty = false;
    window.ec.storefront.product_details_show_wholesale_prices = false;
    window.ec.storefront.product_details_show_product_options = true;
    window.ec.storefront.product_details_show_product_description = true;
    window.ec.storefront.product_details_show_delivery_time = undefined;
    window.ec.storefront.product_details_show_share_buttons = false;
    window.ec.storefront.product_details_position_product_name = 100;
    window.ec.storefront.product_details_position_breadcrumbs = 200;
    window.ec.storefront.product_details_position_product_sku = 300;
    window.ec.storefront.product_details_position_product_price = 400;
    window.ec.storefront.product_details_position_product_options = undefined;
    window.ec.storefront.product_details_position_buy_button = 600;
    window.ec.storefront.product_details_position_wholesale_prices = 700;
    window.ec.storefront.product_details_position_product_description = 900;
    window.ec.storefront.product_details_position_delivery_time = undefined;
    window.ec.storefront.product_details_position_share_buttons = 800;
    window.ec.storefront.product_details_position_subtitle = 500;
    window.ec.storefront.product_details_show_subtitle = true;
  </script>
  <script data-cfasync="false" type="text/javascript" src="https://app.ecwid.com/script.js?106136041&data_platform=singleproduct_v2" charset="utf-8"></script>
  <script type="text/javascript">xProduct()</script>
</div> <!-- end class card -->